// Google Apps Script - ì´ˆí˜¸ì‰¼í„° CTA ë¹ ë¥¸ ë¬¸ì˜ ì‹œìŠ¤í…œ
// ìƒˆ Google Apps Script í”„ë¡œì íŠ¸ë¥¼ ë§Œë“¤ê³  ì´ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”

// ===== ì„¤ì •ê°’ =====
const CONFIG = {
  // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID (URLì—ì„œ ì¶”ì¶œ)
  SPREADSHEET_ID: '14N3JZ-9InoUoZPafSNrSsjLxg_Ik0UpLG4UC6KYalzI',
  
  // í…”ë ˆê·¸ë¨ ì„¤ì • (ê¸°ì¡´ ì„¤ì • ì‚¬ìš©)
  TELEGRAM: {
    BOT_TOKEN: '7947112373:AAEs5o3fcm0JoPewh7K5YTUwzq4poWw97pY',
    CHAT_ID: '-1002863320782' // ê·¸ë£¹ ì±„íŒ… ID
  }
};

// ===== ë©”ì¸ í•¨ìˆ˜ - POST ìš”ì²­ ì²˜ë¦¬ =====
function doPost(e) {
  try {
    // CORS í—¤ë” ì„¤ì •
    const output = ContentService.createTextOutput();
    output.setMimeType(ContentService.MimeType.JSON);
    
    // POST ë°ì´í„° íŒŒì‹±
    const data = JSON.parse(e.postData.contents);
    
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥
    const rowNumber = saveToSpreadsheet(data);
    
    // í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡
    const telegramResult = sendTelegramNotification(data, rowNumber);
    
    // ì„±ê³µ ì‘ë‹µ
    return output.setContent(JSON.stringify({
      status: 'success',
      message: 'ë¹ ë¥¸ ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.',
      row: rowNumber
    }));
    
  } catch (error) {
    console.error('Error:', error);
    
    // ì—ëŸ¬ ì‘ë‹µ
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ===== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ í•¨ìˆ˜ =====
function saveToSpreadsheet(data) {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = spreadsheet.getSheets()[0]; // ì²« ë²ˆì§¸ ì‹œíŠ¸ ì‚¬ìš©
    
    // í—¤ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (sheet.getLastRow() === 0) {
      const headers = [
        'ì ‘ìˆ˜ì¼',
        'ë‹´ë‹¹ì ì„±í•¨',
        'ì—°ë½ì²˜',
        'ì´ë©”ì¼',
        'ì´ìš©í¬ë§ì¼',
        'ì˜ˆìƒì¸ì›',
        'í…”ë ˆê·¸ë¨ ë°œì†¡ê²°ê³¼',
        'ë¬¸ìë°œì†¡ ê²°ê³¼'
      ];
      
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      
      // í—¤ë” ìŠ¤íƒ€ì¼ ì„¤ì •
      const headerRange = sheet.getRange(1, 1, 1, headers.length);
      headerRange.setBackground('#2d5016');
      headerRange.setFontColor('#ffffff');
      headerRange.setFontWeight('bold');
      headerRange.setHorizontalAlignment('center');
      
      // ì—´ ë„ˆë¹„ ì„¤ì •
      sheet.setColumnWidth(1, 150); // ì ‘ìˆ˜ì¼
      sheet.setColumnWidth(2, 100); // ë‹´ë‹¹ì ì„±í•¨
      sheet.setColumnWidth(3, 120); // ì—°ë½ì²˜
      sheet.setColumnWidth(4, 200); // ì´ë©”ì¼
      sheet.setColumnWidth(5, 120); // ì´ìš©í¬ë§ì¼
      sheet.setColumnWidth(6, 100); // ì˜ˆìƒì¸ì›
      sheet.setColumnWidth(7, 150); // í…”ë ˆê·¸ë¨ ë°œì†¡ê²°ê³¼
      sheet.setColumnWidth(8, 150); // ë¬¸ìë°œì†¡ ê²°ê³¼
      
      // ì‹œíŠ¸ ì´ë¦„ ì„¤ì •
      sheet.setName('ë¹ ë¥¸ë¬¸ì˜');
    }
    
    // í˜„ì¬ ì‹œê°„ (í•œêµ­ ì‹œê°„)
    const koreanTime = Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');
    
    // ì´ìš©í¬ë§ì¼ í¬ë§·íŒ…
    let desiredDate = data.desiredDate || 'ë¯¸ì •';
    if (desiredDate && desiredDate !== 'ë¯¸ì •') {
      try {
        const dateObj = new Date(desiredDate);
        desiredDate = Utilities.formatDate(dateObj, 'Asia/Seoul', 'yyyy-MM-dd');
      } catch (e) {
        desiredDate = data.desiredDate;
      }
    }
    
    // ë°ì´í„° í–‰ ì¶”ê°€
    const newRow = sheet.getLastRow() + 1;
    const rowData = [
      koreanTime,                          // A: ì ‘ìˆ˜ì¼
      data.customerName || '',             // B: ë‹´ë‹¹ì ì„±í•¨
      data.customerPhone || '',            // C: ì—°ë½ì²˜
      data.customerEmail || '',            // D: ì´ë©”ì¼
      desiredDate,                         // E: ì´ìš©í¬ë§ì¼
      data.people ? `${data.people}ëª…` : '', // F: ì˜ˆìƒì¸ì›
      'ëŒ€ê¸°ì¤‘',                             // G: í…”ë ˆê·¸ë¨ ë°œì†¡ê²°ê³¼ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸)
      '-'                                   // H: ë¬¸ìë°œì†¡ ê²°ê³¼
    ];
    
    sheet.getRange(newRow, 1, 1, rowData.length).setValues([rowData]);
    
    // ìƒˆë¡œìš´ í–‰ ìŠ¤íƒ€ì¼ ì„¤ì • (ì§ìˆ˜ í–‰ ë°°ê²½ìƒ‰)
    if (newRow % 2 === 0) {
      sheet.getRange(newRow, 1, 1, rowData.length).setBackground('#f5f5f5');
    }
    
    // í…ìŠ¤íŠ¸ ì •ë ¬
    sheet.getRange(newRow, 1, 1, rowData.length).setHorizontalAlignment('center');
    
    return newRow;
    
  } catch (error) {
    console.error('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
    throw error;
  }
}

// ===== í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡ í•¨ìˆ˜ =====
function sendTelegramNotification(data, rowNumber) {
  try {
    // ì´ìš©í¬ë§ì¼ í¬ë§·íŒ…
    let desiredDateText = data.desiredDate || 'ë¯¸ì •';
    if (desiredDateText && desiredDateText !== 'ë¯¸ì •') {
      try {
        const dateObj = new Date(desiredDateText);
        const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayName = dayNames[dateObj.getDay()];
        desiredDateText = Utilities.formatDate(dateObj, 'Asia/Seoul', `yyyyë…„ MMì›” ddì¼ (${dayName})`);
      } catch (e) {
        desiredDateText = data.desiredDate;
      }
    }
    
    // í˜„ì¬ ì‹œê°„
    const koreanTime = Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');
    
    // ë©”ì‹œì§€ êµ¬ì„±
    const message = `
ğŸš€ *ë¹ ë¥¸ ê²¬ì  ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!*

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“‹ *ê³ ê° ì •ë³´*
â€¢ ë‹´ë‹¹ì: ${data.customerName}
â€¢ ì—°ë½ì²˜: [${data.customerPhone}](tel:${data.customerPhone.replace(/-/g, '')})
â€¢ ì´ë©”ì¼: ${data.customerEmail}

ğŸ“… *ì˜ˆì•½ ì •ë³´*
â€¢ í¬ë§ì¼: ${desiredDateText}
â€¢ ì˜ˆìƒ ì¸ì›: ${data.people}ëª…

â° ì ‘ìˆ˜ ì‹œê°„: ${koreanTime}
ğŸ“ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í–‰: ${rowNumber}ë²ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš¡ *ë¹ ë¥¸ ì‘ëŒ€ ë¶€íƒë“œë¦½ë‹ˆë‹¤!*
ğŸ“ ê³ ê°ì—ê²Œ 30ë¶„ ì´ë‚´ ì—°ë½ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

[ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë°”ë¡œê°€ê¸°](https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID})
`;

    // í…”ë ˆê·¸ë¨ API í˜¸ì¶œ
    const url = `https://api.telegram.org/bot${CONFIG.TELEGRAM.BOT_TOKEN}/sendMessage`;
    
    const options = {
      method: 'post',
      contentType: 'application/json',
      payload: JSON.stringify({
        chat_id: CONFIG.TELEGRAM.CHAT_ID,
        text: message,
        parse_mode: 'Markdown',
        disable_web_page_preview: false // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ë¯¸ë¦¬ë³´ê¸° í—ˆìš©
      })
    };
    
    const response = UrlFetchApp.fetch(url, options);
    const result = JSON.parse(response.getContentText());
    
    // ë°œì†¡ ê²°ê³¼ë¥¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì—…ë°ì´íŠ¸
    updateTelegramStatus(rowNumber, result.ok ? 'ë°œì†¡ì™„ë£Œ' : 'ë°œì†¡ì‹¤íŒ¨');
    
    console.log('í…”ë ˆê·¸ë¨ ë°œì†¡ ì„±ê³µ:', result);
    return result;
    
  } catch (error) {
    console.error('í…”ë ˆê·¸ë¨ ë°œì†¡ ì‹¤íŒ¨:', error);
    
    // ë°œì†¡ ì‹¤íŒ¨ ìƒíƒœ ì—…ë°ì´íŠ¸
    try {
      updateTelegramStatus(rowNumber, 'ë°œì†¡ì‹¤íŒ¨');
    } catch (updateError) {
      console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
    }
    
    // í…”ë ˆê·¸ë¨ ì‹¤íŒ¨í•´ë„ ì „ì²´ í”„ë¡œì„¸ìŠ¤ëŠ” ê³„ì† ì§„í–‰
    return { ok: false, error: error.toString() };
  }
}

// ===== í…”ë ˆê·¸ë¨ ë°œì†¡ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ =====
function updateTelegramStatus(rowNumber, status) {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = spreadsheet.getSheets()[0];
    
    // Gì—´ (7ë²ˆì§¸ ì—´)ì— ë°œì†¡ ê²°ê³¼ ì—…ë°ì´íŠ¸
    sheet.getRange(rowNumber, 7).setValue(status);
    
    // ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
    if (status === 'ë°œì†¡ì™„ë£Œ') {
      sheet.getRange(rowNumber, 7).setFontColor('#4caf50');
    } else if (status === 'ë°œì†¡ì‹¤íŒ¨') {
      sheet.getRange(rowNumber, 7).setFontColor('#f44336');
    }
    
  } catch (error) {
    console.error('í…”ë ˆê·¸ë¨ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
  }
}

// ===== CORS ì²˜ë¦¬ìš© GET ë©”ì„œë“œ =====
function doGet() {
  return ContentService.createTextOutput(JSON.stringify({
    status: 'ready',
    message: 'ì´ˆí˜¸ì‰¼í„° CTA ë¹ ë¥¸ ë¬¸ì˜ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.',
    timestamp: new Date().toISOString(),
    spreadsheetUrl: `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}`
  })).setMimeType(ContentService.MimeType.JSON);
}

// ===== í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ =====
function testQuickInquiry() {
  const testData = {
    type: 'quick_inquiry',
    customerName: 'í…ŒìŠ¤íŠ¸ ê³ ê°',
    customerPhone: '010-1234-5678',
    customerEmail: 'test@example.com',
    desiredDate: '2025-01-20',
    people: '50',
    source: 'CTA Modal Test',
    timestamp: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })
  };
  
  try {
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ í…ŒìŠ¤íŠ¸
    const rowNumber = saveToSpreadsheet(testData);
    console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì €ì¥ ì„±ê³µ - í–‰ ë²ˆí˜¸:', rowNumber);
    
    // í…”ë ˆê·¸ë¨ ë°œì†¡ í…ŒìŠ¤íŠ¸
    const telegramResult = sendTelegramNotification(testData, rowNumber);
    console.log('âœ… í…”ë ˆê·¸ë¨ ë°œì†¡ ê²°ê³¼:', telegramResult.ok ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
    
    console.log('ğŸ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
    console.log('ğŸ“Š ìŠ¤í”„ë ˆë“œì‹œíŠ¸ í™•ì¸:', `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}`);
    
  } catch (error) {
    console.error('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
  }
}

// ===== ê¶Œí•œ í™•ì¸ í•¨ìˆ˜ =====
function checkPermissions() {
  try {
    // ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ë¦„:', spreadsheet.getName());
    console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì ‘ê·¼ ê¶Œí•œ: OK');
    
    // ì‹œíŠ¸ ì •ë³´
    const sheets = spreadsheet.getSheets();
    console.log('âœ… ì‹œíŠ¸ ê°œìˆ˜:', sheets.length);
    sheets.forEach((sheet, index) => {
      console.log(`  - ì‹œíŠ¸ ${index + 1}: ${sheet.getName()}`);
    });
    
    // í…”ë ˆê·¸ë¨ ë´‡ ì •ë³´ í™•ì¸
    const botUrl = `https://api.telegram.org/bot${CONFIG.TELEGRAM.BOT_TOKEN}/getMe`;
    const response = UrlFetchApp.fetch(botUrl);
    const botInfo = JSON.parse(response.getContentText());
    
    if (botInfo.ok) {
      console.log('âœ… í…”ë ˆê·¸ë¨ ë´‡ ì—°ê²°: OK');
      console.log('  - ë´‡ ì´ë¦„:', botInfo.result.first_name);
      console.log('  - ë´‡ username:', botInfo.result.username);
    }
    
    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
    const email = Session.getActiveUser().getEmail();
    console.log('âœ… í˜„ì¬ ì‚¬ìš©ì:', email);
    
    return true;
    
  } catch (error) {
    console.error('âŒ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
    return false;
  }
}

// ===== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©) =====
function initializeSpreadsheet() {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = spreadsheet.getSheets()[0];
    
    // ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
    sheet.clear();
    
    // í—¤ë” ì„¤ì •
    const headers = [
      'ì ‘ìˆ˜ì¼',
      'ë‹´ë‹¹ì ì„±í•¨',
      'ì—°ë½ì²˜',
      'ì´ë©”ì¼',
      'ì´ìš©í¬ë§ì¼',
      'ì˜ˆìƒì¸ì›',
      'í…”ë ˆê·¸ë¨ ë°œì†¡ê²°ê³¼',
      'ë¬¸ìë°œì†¡ ê²°ê³¼'
    ];
    
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // í—¤ë” ìŠ¤íƒ€ì¼
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setBackground('#2d5016');
    headerRange.setFontColor('#ffffff');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    headerRange.setBorder(true, true, true, true, true, true);
    
    // ì—´ ë„ˆë¹„ ì„¤ì •
    sheet.setColumnWidth(1, 150); // ì ‘ìˆ˜ì¼
    sheet.setColumnWidth(2, 100); // ë‹´ë‹¹ì ì„±í•¨
    sheet.setColumnWidth(3, 120); // ì—°ë½ì²˜
    sheet.setColumnWidth(4, 200); // ì´ë©”ì¼
    sheet.setColumnWidth(5, 120); // ì´ìš©í¬ë§ì¼
    sheet.setColumnWidth(6, 100); // ì˜ˆìƒì¸ì›
    sheet.setColumnWidth(7, 150); // í…”ë ˆê·¸ë¨ ë°œì†¡ê²°ê³¼
    sheet.setColumnWidth(8, 150); // ë¬¸ìë°œì†¡ ê²°ê³¼
    
    // ì‹œíŠ¸ ì´ë¦„ ë³€ê²½
    sheet.setName('ë¹ ë¥¸ë¬¸ì˜');
    
    console.log('âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
    
  } catch (error) {
    console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
  }
}